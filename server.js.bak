// server.js - ProBrush OTP Server
'use strict';

// Load .env variables
require('dotenv').config();

const express = require("express");
const nodemailer = require("nodemailer");
const bodyParser = require("body-parser");
const fs = require("fs");
const path = require("path");

// ----------- ENVIRONMENT VARIABLES (from .env) -----------------

const OTP_API_KEY = process.env.OTP_API_KEY;
const SMTP_HOST   = process.env.SMTP_HOST;
const SMTP_PORT   = parseInt(process.env.SMTP_PORT, 10);
const SMTP_USER   = process.env.SMTP_USER;
const SMTP_PASS   = process.env.SMTP_PASS;
const OTP_TTL_MINUTES = parseInt(process.env.OTP_TTL_MINUTES || "10", 10);

if (!OTP_API_KEY) {
  console.error("âŒ Missing OTP_API_KEY in .env");
  process.exit(1);
}
if (!SMTP_USER || !SMTP_PASS) {
  console.error("âŒ Missing SMTP_USER or SMTP_PASS in .env");
  process.exit(1);
}

// ---------------------------------------------------------------

const PORT = process.env.PORT || 3000;
const OTP_FILE = path.join(__dirname, "otps.json");

// Load OTP store
let otpStore = {};
try {
  if (fs.existsSync(OTP_FILE)) {
    otpStore = JSON.parse(fs.readFileSync(OTP_FILE, "utf8"));
  }
} catch (err) {
  console.log("âš  Failed to load existing OTP file:", err.message);
  otpStore = {};
}

// persist OTPs
function persistStore() {
  try {
    fs.writeFileSync(OTP_FILE, JSON.stringify(otpStore, null, 2), "utf8");
  } catch (err) {
    console.error("âŒ Failed to write otps.json:", err.message);
  }
}

// cleanup expired OTPs
setInterval(() => {
  const now = Date.now();
  let changed = false;

  for (const uid of Object.keys(otpStore)) {
    if (otpStore[uid].expiresAt <= now) {
      delete otpStore[uid];
      changed = true;
    }
  }

  if (changed) persistStore();
}, 60 * 1000);

// Email transporter
const transporter = nodemailer.createTransport({
  host: SMTP_HOST,
  port: SMTP_PORT,
  secure: SMTP_PORT === 465,
  auth: {
    user: SMTP_USER,
    pass: SMTP_PASS
  },
});

// Utility to generate OTP
function genOtp() {
  return Math.floor(100000 + Math.random() * 900000).toString();
}

// API key validator
function requireApiKey(req, res, next) {
  const key = req.get("x-api-key") || req.body.apiKey;
  if (!key || key !== OTP_API_KEY) {
    return res.status(401).json({ success: false, message: "Unauthorized" });
  }
  next();
}

const app = express();
app.use(bodyParser.json());

// Health check
app.get("/_health", (req, res) => {
  res.json({ ok: true });
});

// Send OTP route
app.post("/send-otp", requireApiKey, async (req, res) => {
  console.log("==> /send-otp called");
  console.log("Headers:", req.headers);
  console.log("Body:", req.body);

  const { uid, email } = req.body;

  if (!uid || !email) {
    return res.status(400).json({ success: false, message: "Missing uid or email" });
  }

  const prev = otpStore[uid];
  if (prev && Date.now() - prev.createdAt < 60000) {
    return res.status(429).json({ success: false, message: "Try again in 1 minute" });
  }

  const code = genOtp();
  const now = Date.now();

  otpStore[uid] = {
    code,
    createdAt: now,
    expiresAt: now + OTP_TTL_MINUTES * 60 * 1000
  };

  persistStore();

  const html = `
    <div style="font-family: Arial; padding: 16px;">
      <h2>ProBrush verification code</h2>
      <h1 style="letter-spacing: 6px;">${code}</h1>
      <p>This code expires in ${OTP_TTL_MINUTES} minutes.</p>
    </div>
  `;

  try {
    await transporter.sendMail({
      from: `"ProBrush" <${SMTP_USER}>`,
      to: email,
      subject: "Your ProBrush verification code",
      html
    });

    res.json({ success: true, message: "OTP sent" });
  } catch (err) {
    console.error("âŒ Error sending email:", err);
    res.status(500).json({ success: false, message: "Failed to send email" });
  }
});

// Verify OTP route
app.post("/verify-otp", requireApiKey, (req, res) => {
  console.log("==> /verify-otp called");
  console.log("Headers:", req.headers);
  console.log("Body:", req.body);

  const { uid, code } = req.body;

  if (!uid || !code) {
    return res.status(400).json({ success: false, message: "Missing uid or code" });
  }

  const rec = otpStore[uid];

  if (!rec) {
    return res.status(404).json({ success: false, message: "OTP not found" });
  }

  if (Date.now() > rec.expiresAt) {
    delete otpStore[uid];
    persistStore();
    return res.status(410).json({ success: false, message: "OTP expired" });
  }

  if (rec.code !== code) {
    return res.status(403).json({ success: false, message: "Invalid OTP" });
  }

  delete otpStore[uid];
  persistStore();

  return res.json({ success: true });
});

// Start server
app.listen(PORT, "0.0.0.0", () => {
  console.log(`ðŸš€ OTP server running on http://localhost:${PORT}`);
});
